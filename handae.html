<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>í•œ ëŒ€ â€” ë‹´ì†Œ ê³µê°„ | ì„¸ ëŒ€</title>
  <link rel="stylesheet" href="styles.css" />
  <!-- Leaflet (ì˜¤í”ˆìŠ¤íŠ¸ë¦¬íŠ¸ë§µ) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <!-- Leaflet Routing Machine (OSRM ê¸¸ì°¾ê¸°) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
  <style>
    :root { --olive:#b5a14a; --olive-dark:#6b5b23; }
    body { background:#fff; color:#333; }
    header, footer { background:#fff; }
    .location-header { display:flex; align-items:center; justify-content:space-between; padding:10px 16px; border-bottom:1px solid #ddd; }
    .location-header h1 { font-size:18px; margin:0; font-weight:700; }
    .location-header h1 span { color:var(--olive); }

    .layout { display:grid; grid-template-columns: 1fr; gap:16px; max-width:980px; margin:0 auto; padding:16px; }
    @media (min-width: 880px){ .layout { grid-template-columns: 2fr 1fr; } }

    .card { border:1px solid #e5e7eb; border-radius:12px; padding:14px; background:#fff; }
    .muted { color:#6b7280; font-size:13px; }

    .input-group { display:flex; align-items:center; border-bottom:1px solid #ccc; }
    .input-group input { flex:1; border:none; padding:10px 8px; font-size:14px; }
    .input-group input:focus { outline:none; }

    .destination { font-size:14px; }
    .destination strong { font-weight:700; }
    .distance-info { font-size:14px; }
    .distance-info strong { color:var(--olive); }

    #map { height:360px; border-radius:12px; border:1px solid #e5e7eb; overflow:hidden; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; }
    .btn { background:var(--olive); color:#fff; border:0; border-radius:999px; padding:10px 14px; cursor:pointer; font-weight:700; }
    .btn.secondary { background:#f3f4f6; color:#333; }
    .btn.ghost { background:transparent; border:1px solid #e5e7eb; color:#333; }
    .leaflet-routing-container { display:none; } /* ê¸°ë³¸ íŒ¨ë„ ìˆ¨ê¹€ */

    .nearby-list { display:flex; flex-direction:column; gap:10px; max-height:360px; overflow:auto; }
    .nearby-item { display:flex; justify-content:space-between; align-items:center; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px; }
    .nearby-title { font-weight:700; }
    .pill { background:#fff6d6; color:#6b5b23; border:1px solid #f2e6a8; padding:4px 8px; border-radius:999px; font-size:12px; }
  </style>
</head>
<body>
  <header class="location-header">
    <a href="index.html" aria-label="ë’¤ë¡œ">â†</a>
    <h1>ë‚´ ì£¼ë³€ <span>ì„¸ ëŒ€</span>ì¥ì†Œ</h1>
    <a href="#" style="color:var(--olive)" aria-disabled="true">ì™„ë£Œ</a>
  </header>

  <main class="layout">
    <section class="card">
      <div class="input-group" aria-label="ìƒì„¸ì£¼ì†Œ ì…ë ¥">
        <input type="text" placeholder="ìƒì„¸ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”." />
        <span aria-hidden="true">ğŸ“</span>
      </div>

      <div class="destination" style="margin-top:8px;">
        <strong>ë„ì°© ì¥ì†Œ:</strong> <span id="destLabel">ìœ ì„±êµ¬ ì„¸ ëŒ€</span>
      </div>
      <div class="distance-info" style="margin-top:6px;">
        ê±°ë¦¬/ì˜ˆìƒì‹œê°„ <strong id="eta">ìœ„ì¹˜ í™•ì¸ ì¤‘â€¦</strong> <span id="dist" class="muted"></span>
      </div>

      <div id="map" role="region" aria-label="ì§€ë„" style="margin:10px 0 12px;"></div>
      <div class="actions">
        <button id="locate" class="btn" type="button">í˜„ì¬ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°</button>
        <button id="watch" class="btn ghost" type="button" aria-pressed="false">ì‹¤ì‹œê°„ ì¶”ì  ì¼œê¸°</button>
        <button id="resetView" class="btn secondary" type="button">ëª©ì ì§€ ë³´ê¸°</button>
      </div>

      <div style="margin-top:12px;">
        <input id="query" class="item-input" type="text" placeholder="ì›í•˜ëŠ” ë¬¼ê±´ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" style="padding:10px 12px; border-radius:10px; border:1px solid #ccc; width:100%;" />
        <p class="muted">â€» ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•˜ë©´ í˜„ì¬ ìœ„ì¹˜ì—ì„œ ëª©ì ì§€ê¹Œì§€ ì‹¤ì œ **ë„ë³´ ê²½ë¡œ**ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.</p>
      </div>
    </section>

    <aside class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <h3 style="margin:0; font-size:16px;">ì£¼ë³€ ê³µìœ ê³µê°„</h3>
        <div>
          <span class="muted">ë°˜ê²½</span>
          <select id="radius" class="btn ghost" style="padding:6px 10px;">
            <option value="0.5">0.5 km</option>
            <option value="1.0" selected>1 km</option>
            <option value="2.0">2 km</option>
            <option value="3.0">3 km</option>
          </select>
        </div>
      </div>
      <div id="nearby" class="nearby-list" aria-live="polite"></div>
    </aside>
  </main>

  <footer class="site-footer">
    <div class="container">Â© <span id="year"></span> ì„¸ ëŒ€</div>
  </footer>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    // ===== ì„¤ì •ê°’ =====
    // ê¸°ë³¸ ëª©ì ì§€ ì¢Œí‘œ(ë³€ê²½ ê°€ëŠ¥)
    const DEFAULT_DEST = { lat: 36.3629, lng: 127.3568, label: 'ì„¸ ëŒ€ (ìœ ì„±êµ¬)' };

    // ì£¼ë³€ ê³µìœ ê³µê°„(ìƒ˜í”Œ ë°ì´í„°) â€” ì‹¤ì œ ë°ì´í„°ë¡œ êµì²´í•˜ì„¸ìš”
    const PLACES = [
      { name: 'ì„¸ ëŒ€ ë¼ìš´ì§€', type: 'ê³µìœ ê³µê°„', lat: 36.3642, lng: 127.3561 },
      { name: 'ìœ ì„± ê³µìœ ì‘ì—…ì‹¤', type: 'ë©”ì´ì»¤ìŠ¤í˜ì´ìŠ¤', lat: 36.3605, lng: 127.3610 },
      { name: 'ë™ë„¤ ìŠ¤í„°ë””ë£¸', type: 'ìŠ¤í„°ë””ì¹´í˜', lat: 36.3674, lng: 127.3518 },
      { name: 'ì‘ì€ ì „ì‹œì‹¤', type: 'ê°¤ëŸ¬ë¦¬', lat: 36.3588, lng: 127.3499 }
    ];

    // ===== ì§€ë„/ê¸¸ì°¾ê¸° ì´ˆê¸°í™” =====
    const map = L.map('map', { zoomControl: true });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    let dest = { ...DEFAULT_DEST };
    const destMarker = L.marker([dest.lat, dest.lng]).addTo(map).bindPopup(dest.label);
    map.setView([dest.lat, dest.lng], 15);

    let userMarker = null;
    let watchId = null;

    // Routing Machine â€” OSRM(ê³µìš© ì„œë²„)
    let routingControl = L.Routing.control({
      waypoints: [],
      lineOptions: { styles: [{ color: '#b5a14a', weight: 6, opacity: 0.9 }] },
      addWaypoints: false,
      draggableWaypoints: false,
      routeWhileDragging: false,
      show: false,
      router: L.Routing.osrmv1({
        serviceUrl: 'https://router.project-osrm.org/route/v1',
        profile: 'foot'
      })
    }).addTo(map);

    routingControl.on('routesfound', function(e){
      const best = e.routes[0];
      if (!best) return;
      const meters = best.summary.totalDistance;
      const seconds = best.summary.totalTime;
      document.getElementById('dist').textContent = formatDistance(meters);
      document.getElementById('eta').textContent = 'ë„ë³´ ' + Math.max(1, Math.round(seconds/60)) + 'ë¶„';
    });

    function formatDistance(m){
      if (!isFinite(m)) return '';
      if (m >= 1000) return (m/1000).toFixed(1) + ' km';
      return Math.round(m) + ' m';
    }

    function setUser(lat, lng){
      if (!userMarker) {
        userMarker = L.marker([lat, lng], { title: 'í˜„ì¬ ìœ„ì¹˜' }).addTo(map).bindPopup('í˜„ì¬ ìœ„ì¹˜');
      } else {
        userMarker.setLatLng([lat, lng]);
      }
      routingControl.setWaypoints([
        L.latLng(lat, lng),
        L.latLng(dest.lat, dest.lng)
      ]);
      refreshNearby();
    }

    function locateOnce(){
      if (!navigator.geolocation){
        document.getElementById('eta').textContent = 'ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ë¥¼ ì§€ì›í•˜ì§€ ì•Šì•„ìš”';
        return;
      }
      navigator.geolocation.getCurrentPosition(
        pos => setUser(pos.coords.latitude, pos.coords.longitude),
        err => { console.warn(err); document.getElementById('eta').textContent = 'ìœ„ì¹˜ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤'; },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 10000 }
      );
    }

    function toggleWatch(){
      const btn = document.getElementById('watch');
      const on = btn.getAttribute('aria-pressed') === 'true';
      if (on){
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
        btn.setAttribute('aria-pressed','false');
        btn.textContent = 'ì‹¤ì‹œê°„ ì¶”ì  ì¼œê¸°';
      } else {
        if (!navigator.geolocation) return;
        watchId = navigator.geolocation.watchPosition(
          pos => setUser(pos.coords.latitude, pos.coords.longitude),
          err => console.warn(err),
          { enableHighAccuracy: true, maximumAge: 5000, timeout: 15000 }
        );
        btn.setAttribute('aria-pressed','true');
        btn.textContent = 'ì‹¤ì‹œê°„ ì¶”ì  ë„ê¸°';
      }
    }

    document.getElementById('locate').addEventListener('click', locateOnce);
    document.getElementById('watch').addEventListener('click', toggleWatch);
    document.getElementById('resetView').addEventListener('click', ()=>{
      dest = { ...DEFAULT_DEST };
      document.getElementById('destLabel').textContent = dest.label;
      destMarker.setLatLng([dest.lat, dest.lng]).bindPopup(dest.label);
      if (userMarker){ routingControl.setWaypoints([ userMarker.getLatLng(), L.latLng(dest.lat, dest.lng) ]); }
      map.setView([dest.lat, dest.lng], 15);
      refreshNearby();
    });

    // ===== ì£¼ë³€ ê³µìœ ê³µê°„ ë Œë”ë§ =====
    const placesLayer = L.layerGroup().addTo(map);
    const nearbyEl = document.getElementById('nearby');
    document.getElementById('radius').addEventListener('change', refreshNearby);

    function refreshNearby(){
      placesLayer.clearLayers();
      nearbyEl.innerHTML = '';
      const rkm = parseFloat(document.getElementById('radius').value || '1');
      const center = userMarker ? userMarker.getLatLng() : L.latLng(dest.lat, dest.lng);

      const enriched = PLACES.map(p => {
        const d = map.distance(center, L.latLng(p.lat, p.lng));
        return { ...p, meters: d };
      }).filter(p => p.meters <= rkm * 1000)
        .sort((a,b)=> a.meters - b.meters);

      if (!enriched.length){
        nearbyEl.innerHTML = '<div class="muted">ì£¼ë³€ ë°˜ê²½ ë‚´ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      enriched.forEach(p => {
        const m = L.marker([p.lat, p.lng]).addTo(placesLayer).bindPopup(`${p.name}<br><button id="go-${p.lat}-${p.lng}" style="margin-top:6px;" class="btn">ì—¬ê¸°ë¡œ ê¸¸ì°¾ê¸°</button>`);
        m.on('popupopen', ()=>{
          const btn = document.getElementById(`go-${p.lat}-${p.lng}`);
          if (btn) btn.addEventListener('click', ()=> setDestination(p));
        });

        const item = document.createElement('div');
        item.className = 'nearby-item';
        item.innerHTML = `
          <div>
            <div class="nearby-title">${p.name}</div>
            <div class="muted">${p.type} Â· ${formatDistance(p.meters)}</div>
          </div>
          <button class="btn" type="button">ê¸¸ì°¾ê¸°</button>
        `;
        item.querySelector('button').addEventListener('click', ()=> setDestination(p));
        nearbyEl.appendChild(item);
      });
    }

    function setDestination(p){
      dest = { lat: p.lat, lng: p.lng, label: p.name };
      document.getElementById('destLabel').textContent = dest.label;
      destMarker.setLatLng([dest.lat, dest.lng]).bindPopup(dest.label).openPopup();
      if (userMarker){ routingControl.setWaypoints([ userMarker.getLatLng(), L.latLng(dest.lat, dest.lng) ]); }
      map.setView([dest.lat, dest.lng], 15);
    }

    // ì´ˆê¸° í•œ ë²ˆ ì‹œë„ & ì£¼ë³€ ëª©ë¡ ì¤€ë¹„
    locateOnce();
    refreshNearby();
  </script>
</body>
</html>